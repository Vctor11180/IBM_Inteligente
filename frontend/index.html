<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>NutriLife</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Ethers.js para interactuar con blockchain -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>

<header class="topbar">
    <div class="brand">
        <div class="logo">üçÉ</div>
        <span>NutriLife</span>
    </div>

    <nav>
        <button class="nav-btn active" onclick="mostrarVista('imc')">Calculadora IMC</button>
        <button class="nav-btn" onclick="mostrarVista('reco')">Recomendaciones</button>
        <button class="nav-btn" onclick="mostrarVista('analizar')">üì∑ Analizar Comida</button>
        <button class="nav-btn" onclick="mostrarVista('bot')">NutriBot</button>
        <button class="nav-btn" onclick="mostrarVista('historial')">üìú Historial</button>
    </nav>

    <!-- Indicador de Wallet -->
    <div class="wallet-status" id="walletStatus">
        <button class="wallet-btn" id="walletBtn" onclick="toggleWallet()">
            üîó Conectar Wallet
        </button>
        <div class="wallet-info hidden" id="walletInfo">
            <span class="wallet-address" id="walletAddress"></span>
            <button class="disconnect-btn" onclick="desconectarWallet()">Desconectar</button>
        </div>
    </div>
</header>

<main>

<section id="vista-imc">

    <section class="card">
        <div class="card-header">
            <div class="icon">üßÆ</div>
            <h2>Calculadora de IMC</h2>
            <p>
                Ingresa tus datos para calcular tu √çndice de Masa Corporal
                y recibir recomendaciones personalizadas
            </p>
        </div>

        <div class="field">
            <label>Edad <span id="edadVal">21</span> a√±os</label>
            <input type="range" min="10" max="80" value="21"
                   oninput="edadVal.innerText=this.value">
        </div>

        <div class="field">
            <label>Peso <span id="pesoVal">67.1</span> kg</label>
            <input type="range" min="30" max="120" step="0.1" value="67.1"
                   oninput="pesoVal.innerText=this.value">
        </div>

        <div class="field">
            <label>Altura <span id="alturaVal">1.67</span> m</label>
            <input type="range" min="1.40" max="2.10" step="0.01" value="1.67"
                   oninput="alturaVal.innerText=this.value">
        </div>

        <div class="activity">
            <label>Nivel de Actividad F√≠sica</label>
            <div class="activity-group">
                <button class="activity-btn active">Sedentario</button>
                <button class="activity-btn">Ligera</button>
                <button class="activity-btn">Moderada</button>
                <button class="activity-btn">Alta</button>
            </div>
        </div>

        <button class="primary-btn" onclick="calcularIMCColab()">
    Calcular mi IMC
</button>


    </section>

</section>

<section id="vista-reco" class="hidden">

    <div class="reco-header">
        <div class="reco-icon">üç¥</div>
        <h2>Recomendaciones Personalizadas</h2>
        <p>Plan nutricional adaptado a tu IMC, altura y nivel de actividad f√≠sica</p>
    </div>

    <div class="reco-main">
        <div class="goal">
            <small>Tu Objetivo</small>
            <h3 id="objetivoReco">Mantener peso saludable y equilibrio nutricional</h3>
        </div>

        <div class="calories-box">
            <small>Calor√≠as Diarias Sugeridas</small>
            <strong id="caloriasReco">1932 kcal</strong>
        </div>
    </div>

    <div class="meals">
        <div class="meal-card">
            <div class="meal-title">‚òÄÔ∏è Desayuno</div>
            <small id="horaDesayuno">7:00 - 9:00 AM</small>
            <p id="descDesayuno">Yogurt natural con frutas frescas y granola</p>
            <div class="meal-info">
                <span class="cal" id="calDes">350 Cal</span>
                <span class="prot" id="protDes">18g Prot</span>
            </div>
        </div>

        <div class="meal-card">
            <div class="meal-title">üçΩÔ∏è Almuerzo</div>
            <small id="horaAlm">12:00 - 2:00 PM</small>
            <p id="descAlm">Pechuga de pollo a la plancha, ensalada y arroz</p>
            <div class="meal-info">
                <span class="cal" id="calAlm">500 Cal</span>
                <span class="prot" id="protAlm">35g Prot</span>
            </div>
        </div>

        <div class="meal-card">
            <div class="meal-title">üåô Cena</div>
            <small id="horaCena">7:00 - 9:00 PM</small>
            <p id="descCena">Pescado al vapor con verduras asadas</p>
            <div class="meal-info">
                <span class="cal" id="calCena">400 Cal</span>
                <span class="prot" id="protCena">30g Prot</span>
            </div>
        </div>
    </div>

    <div class="snacks">
        <h4>üçè Snacks Saludables</h4>
        <div class="snack-list" id="snacksReco">
            <span>Frutas frescas variadas</span>
            <span>Almendras (30g)</span>
            <span>Zanahoria con hummus</span>
        </div>
    </div>

    <div class="tips">
        <h4>üí° Consejos Importantes</h4>
        <ul id="tipsReco">
            <li>üíß Bebe al menos 2 litros de agua</li>
            <li>üèÉ Realiza actividad f√≠sica regular</li>
            <li>üò¥ Duerme entre 7-8 horas</li>
            <li>üìí Lleva un registro alimenticio</li>
        </ul>
    </div>

</section>

<!-- nutribot -->
<section id="vista-bot" class="hidden">

    <div class="bot-header">
        <div class="bot-icon">üí¨</div>
        <h2>NutriBot</h2>
        <p>
            Tu asistente inteligente de nutrici√≥n. Preg√∫ntame lo que necesites
            o env√≠a una imagen de alimentos.
        </p>
    </div>

    <!-- chat -->
    <div class="chat-box">

        <div class="message bot">
            ¬°Hola! Soy NutriBot, tu asistente de nutrici√≥n.
            Puedo ayudarte con consejos nutricionales y analizar im√°genes de alimentos.
            ¬øEn qu√© puedo ayudarte hoy?
        </div>

        <!-- MENSAJES DE COLAB SE INSERTAN AQU√ç -->
        <div id="chat-messages"></div>

    </div>

    <!-- INPUT -->
    <div class="chat-input">
        <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="analizarImagenDesdeChat(event)">
        <button class="img-btn" onclick="document.getElementById('imageInput').click()" title="Subir imagen">üì∑</button>
        <input type="text" id="userMessage" placeholder="Escribe tu consulta de nutrici√≥n..." onkeypress="if(event.key === 'Enter') enviarMensaje()">
        <button class="send-btn" onclick="enviarMensaje()" title="Enviar mensaje">‚û§</button>
    </div>

    <!-- FAQ -->
    <div class="faq">
        <h4>Preguntas Frecuentes</h4>
        <div class="faq-list">
            <button onclick="hacerPregunta('¬øCu√°nta prote√≠na necesito?')">¬øCu√°nta prote√≠na necesito?</button>
            <button onclick="hacerPregunta('Tips para adelgazar')">Tips para adelgazar</button>
            <button onclick="hacerPregunta('Mejores snacks saludables')">Mejores snacks saludables</button>
            <button onclick="hacerPregunta('Hidrataci√≥n recomendada')">Hidrataci√≥n recomendada</button>
            <button onclick="hacerPregunta('Nutrici√≥n pre-entreno')">Nutrici√≥n pre-entreno</button>
            <button onclick="hacerPregunta('Desayunos saludables')">Desayunos saludables</button>
        </div>
    </div>

</section>

<!-- Vista Analizar Comida -->
<section id="vista-analizar" class="hidden">

    <div class="bot-header">
        <div class="bot-icon">üì∑</div>
        <h2>Analizar Comida</h2>
        <p>Sube una imagen de tu comida para recibir an√°lisis nutricional personalizado</p>
    </div>

    <!-- √Årea de subida -->
    <div class="upload-area" id="uploadArea" 
         ondrop="handleDrop(event)" 
         ondragover="handleDragOver(event)" 
         ondragleave="handleDragLeave(event)">
        <input type="file" id="fileInput" accept="image/*" onchange="previewImagen(event)" style="display:none">
        <div class="upload-content" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">üì∑</div>
            <p>Haz clic o arrastra una imagen aqu√≠</p>
            <small>Formatos: JPG, PNG, JPEG (m√°x. 10MB)</small>
        </div>
    </div>

    <!-- Vista previa de imagen -->
    <div class="image-preview hidden" id="imagePreview">
        <img id="previewImg" src="" alt="Vista previa">
        <button class="remove-img-btn" onclick="removerImagen()">‚úï</button>
        <div class="preview-actions">
            <button class="primary-btn" onclick="analizarImagen()" id="btnAnalizar">
                üîç Analizar Comida
            </button>
        </div>
    </div>

    <!-- Estado de carga -->
    <div class="loading-state hidden" id="loadingState">
        <div class="spinner"></div>
        <p>Analizando imagen con IA...</p>
    </div>

    <!-- Resultados del an√°lisis -->
    <div class="analysis-results hidden" id="analysisResults">
        <div class="result-card-main">
            <div class="result-status" id="resultStatus">
                <div class="status-icon" id="statusIcon">‚úÖ</div>
                <h3 id="resultTitle">Porci√≥n Correcta</h3>
                <p class="confidence" id="confidenceText">Confianza: 85%</p>
            </div>

            <div class="result-details">
                <div class="detail-item">
                    <span class="detail-label">Calor√≠as Estimadas</span>
                    <span class="detail-value" id="caloriasEst">450 kcal</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Peso Estimado</span>
                    <span class="detail-value" id="pesoEst">350 g</span>
                </div>
            </div>
        </div>

        <div class="recommendation-box" id="recommendationBox">
            <h4>üí° Recomendaci√≥n Personalizada</h4>
            <p id="recommendationText">Porci√≥n adecuada para tu objetivo cal√≥rico.</p>
        </div>

        <button class="secondary-btn" onclick="analizarOtra()">
            üì∑ Analizar otra imagen
        </button>
    </div>

</section>

</main>

<script>
const API_URL = "http://localhost:5000/api"; 
let imagenActual = null;
let datosUsuarioIMC = null;

// Guardar datos del usuario cuando calcula IMC
function guardarDatosUsuario(resultado) {
    datosUsuarioIMC = {
        imc: resultado.imc,
        categoria: resultado.categoria,
        calorias: resultado.calorias,
        objetivo: resultado.objetivo
    };
    localStorage.setItem('datosUsuarioIMC', JSON.stringify(datosUsuarioIMC));
}

// Cargar datos guardados al iniciar
window.addEventListener('DOMContentLoaded', () => {
    const datosGuardados = localStorage.getItem('datosUsuarioIMC');
    if (datosGuardados) {
        datosUsuarioIMC = JSON.parse(datosGuardados);
    }
    mostrarVista("imc");
});

/* ============================= */
/* CALCULAR IMC ‚Üí COLAB */
/* ============================= */
async function calcularIMCColab() {

    const data = {
        edad: parseInt(document.getElementById("edadVal").innerText),
        peso: parseFloat(document.getElementById("pesoVal").innerText),
        altura: parseFloat(document.getElementById("alturaVal").innerText),
        actividad: document.querySelector(".activity-btn.active").innerText
    };

    try {
        const res = await fetch(`${API_URL}/calcular-imc`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (!res.ok) {
            throw new Error(`Error del servidor: ${res.status} ${res.statusText}`);
        }

        const result = await res.json();

        // Guardar datos del usuario
        guardarDatosUsuario(result);

        // üëâ RESULTADOS DESDE COLAB
        document.getElementById("objetivoReco").innerText = result.objetivo;
        document.getElementById("caloriasReco").innerText = result.calorias + " kcal";

        // Comidas
        document.getElementById("descDesayuno").innerText = result.desayuno.descripcion;
        document.getElementById("calDes").innerText = result.desayuno.calorias + " Cal";
        document.getElementById("protDes").innerText = result.desayuno.proteinas + "g Prot";

        document.getElementById("descAlm").innerText = result.almuerzo.descripcion;
        document.getElementById("calAlm").innerText = result.almuerzo.calorias + " Cal";
        document.getElementById("protAlm").innerText = result.almuerzo.proteinas + "g Prot";

        document.getElementById("descCena").innerText = result.cena.descripcion;
        document.getElementById("calCena").innerText = result.cena.calorias + " Cal";
        document.getElementById("protCena").innerText = result.cena.proteinas + "g Prot";

        // Snacks
        const snacksDiv = document.getElementById("snacksReco");
        snacksDiv.innerHTML = "";
        result.snacks.forEach(snack => {
            snacksDiv.innerHTML += `<span>${snack}</span>`;
        });

        // Tips
        const tipsDiv = document.getElementById("tipsReco");
        tipsDiv.innerHTML = "";
        result.tips.forEach(tip => {
            tipsDiv.innerHTML += `<li>${tip}</li>`;
        });

        // üëâ CAMBIAR DE VISTA
        mostrarVista("reco");

    } catch (error) {
        alert("Error al conectar con el servidor. Aseg√∫rate de que el backend est√© corriendo en http://localhost:5000");
        console.error("Error:", error);
    }
}

function mostrarVista(vista) {
    // Oculta todas las vistas
    document.querySelectorAll("section[id^='vista-']")
        .forEach(v => v.classList.add("hidden"));

    // Muestra la vista seleccionada
    document.getElementById("vista-" + vista).classList.remove("hidden");

    // Quita clase active de todos los botones
    document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));

    // A√±ade clase active al bot√≥n correspondiente
    document.querySelector(`.nav-btn[onclick="mostrarVista('${vista}')"]`).classList.add("active");
    
    // Si es la vista de historial, cargar datos
    if (vista === 'historial') {
        cargarHistorial();
    }
}


/* ============================= */
/* AN√ÅLISIS DE IM√ÅGENES */
/* ============================= */

function previewImagen(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validar tipo
    if (!file.type.startsWith('image/')) {
        alert('Por favor, selecciona una imagen v√°lida');
        return;
    }

    // Validar tama√±o (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('La imagen es muy grande. M√°ximo 10MB');
        return;
    }

    imagenActual = file;

    // Mostrar vista previa
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('previewImg').src = e.target.result;
        document.getElementById('uploadArea').classList.add('hidden');
        document.getElementById('imagePreview').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
}

function removerImagen() {
    imagenActual = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('imagePreview').classList.add('hidden');
    document.getElementById('analysisResults').classList.add('hidden');
    document.getElementById('loadingState').classList.add('hidden');
}

function analizarOtra() {
    removerImagen();
}

async function analizarImagen() {
    if (!imagenActual) {
        alert('Por favor, selecciona una imagen primero');
        return;
    }

    // Obtener datos del usuario (desde localStorage o usar valores por defecto)
    let datosUsuario = {
        imc: 22.5,
        categoria_imc: 'Normal',
        calorias_objetivo: 2000,
        objetivo: 'mantener peso'
    };

    if (datosUsuarioIMC) {
        datosUsuario = {
            imc: datosUsuarioIMC.imc,
            categoria_imc: datosUsuarioIMC.categoria,
            calorias_objetivo: datosUsuarioIMC.calorias,
            objetivo: datosUsuarioIMC.objetivo.toLowerCase().includes('mantener') ? 'mantener peso' :
                     datosUsuarioIMC.objetivo.toLowerCase().includes('perder') ? 'perder peso' :
                     datosUsuarioIMC.objetivo.toLowerCase().includes('ganar') ? 'ganar peso' : 'mantener peso'
        };
    } else {
        // Si no hay datos, usar valores por defecto autom√°ticamente (m√°s user-friendly)
        console.log('No hay datos de IMC guardados. Usando valores por defecto.');
        // Los valores por defecto ya est√°n definidos arriba
        // Solo mostramos un mensaje informativo en consola, no interrumpimos el flujo
    }

    // Mostrar estado de carga
    document.getElementById('loadingState').classList.remove('hidden');
    document.getElementById('analysisResults').classList.add('hidden');
    document.getElementById('btnAnalizar').disabled = true;

    try {
        // Preparar FormData
        const formData = new FormData();
        formData.append('imagen', imagenActual);
        formData.append('imc', datosUsuario.imc);
        formData.append('categoria_imc', datosUsuario.categoria_imc);
        formData.append('calorias_objetivo', datosUsuario.calorias_objetivo);
        formData.append('objetivo', datosUsuario.objetivo);

        // Enviar al backend
        const response = await fetch(`${API_URL}/analizar-imagen`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Error al analizar la imagen');
        }

        // Mostrar resultados
        mostrarResultados(result);

    } catch (error) {
        console.error('Error:', error);
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('btnAnalizar').disabled = false;
        
        let mensajeError = 'Error al analizar la imagen.\n\n';
        
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            mensajeError += '‚ö†Ô∏è El backend no est√° corriendo.\n\n';
            mensajeError += 'Para solucionarlo:\n';
            mensajeError += '1. Abre una terminal\n';
            mensajeError += '2. Ejecuta: python backend/app.py\n';
            mensajeError += '3. Espera a ver "Servidor corriendo"\n';
            mensajeError += '4. Intenta analizar de nuevo';
        } else {
            mensajeError += `Detalle: ${error.message}`;
        }
        
        alert(mensajeError);
    }
}

function mostrarResultados(result) {
    const analisis = result.analisis;
    const recomendacion = result.recomendacion;

    // Ocultar carga, mostrar resultados
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('analysisResults').classList.remove('hidden');
    document.getElementById('btnAnalizar').disabled = false;

    // Actualizar estado (porci√≥n correcta/exceso)
    const resultStatus = document.getElementById('resultStatus');
    const statusIcon = document.getElementById('statusIcon');
    const resultTitle = document.getElementById('resultTitle');
    const confidenceText = document.getElementById('confidenceText');

    // Clasificaci√≥n mejorada considerando probabilidades
    const probExceso = analisis.probabilidad_exceso;
    const confianza = analisis.confianza;
    
    // Si la probabilidad de exceso es > 0.35, mostrar como exceso (m√°s estricto)
    // Esto ayuda a detectar mejor los platos rebalsados
    if (analisis.porcion_correcta && probExceso < 0.35) {
        statusIcon.textContent = '‚úÖ';
        resultTitle.textContent = 'Porci√≥n Correcta';
        resultStatus.className = 'result-status correct';
    } else if (!analisis.porcion_correcta || probExceso >= 0.35) {
        statusIcon.textContent = '‚ö†Ô∏è';
        resultTitle.textContent = 'Exceso de Porci√≥n';
        resultStatus.className = 'result-status excess';
        
        // Si la probabilidad est√° entre 0.35 y 0.5, mostrar como posible exceso
        if (probExceso >= 0.35 && probExceso < 0.5) {
            resultTitle.textContent = 'Posible Exceso de Porci√≥n';
        }
    }

    // Mostrar confianza con color seg√∫n el nivel
    const nivelConfianza = analisis.nivel_confianza || 'media';
    let confianzaColor = '#6b7280'; // gris por defecto
    if (nivelConfianza === 'alta') confianzaColor = '#22c55e'; // verde
    else if (nivelConfianza === 'media') confianzaColor = '#f59e0b'; // amarillo
    else confianzaColor = '#ef4444'; // rojo
    
    confidenceText.textContent = `Confianza: ${(confianza * 100).toFixed(1)}%`;
    confidenceText.style.color = confianzaColor;
    
    // Mostrar advertencia si la confianza es baja
    if (analisis.advertencia) {
        const advertenciaDiv = document.createElement('div');
        advertenciaDiv.className = 'advertencia-baja-confianza';
        advertenciaDiv.innerHTML = `‚ö†Ô∏è ${analisis.advertencia}`;
        advertenciaDiv.style.cssText = 'background: #fef3c7; color: #92400e; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 14px;';
        resultStatus.appendChild(advertenciaDiv);
    }
    
    // Mostrar informaci√≥n de IPFS si est√° disponible
    if (result.ipfs && result.ipfs.cid) {
        const ipfsSection = document.createElement('div');
        ipfsSection.className = 'ipfs-info';
        ipfsSection.style.cssText = 'background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-top: 16px;';
        
        ipfsSection.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 20px;">üåê</span>
                <h4 style="margin: 0; color: #0c4a6e; font-size: 16px;">Almacenado en IPFS</h4>
            </div>
            <div style="font-size: 13px; color: #075985; margin-bottom: 8px;">
                <strong>CID:</strong> <code style="background: white; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">${result.ipfs.cid}</code>
            </div>
            <a href="${result.ipfs.url}" target="_blank" style="color: #0284c7; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;">
                üîó Ver imagen en IPFS ‚Üí
            </a>
        `;
        
        resultStatus.appendChild(ipfsSection);
        
        // Mostrar secci√≥n de blockchain despu√©s de IPFS
        document.getElementById('blockchainSection').style.display = 'block';
    } else {
        document.getElementById('blockchainSection').style.display = 'none';
    }

    // Guardar resultado para usar en blockchain
    window.resultadoActual = result;

    // Detalles
    document.getElementById('caloriasEst').textContent = `${recomendacion.calorias_estimadas} kcal`;
    document.getElementById('pesoEst').textContent = `${recomendacion.gramos_estimados} g`;

    // Recomendaci√≥n
    document.getElementById('recommendationText').textContent = recomendacion.mensaje;
}

// Funci√≥n para analizar desde el chat de NutriBot
async function analizarImagenDesdeChat(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Cambiar a vista de an√°lisis
    mostrarVista('analizar');

    // Simular el evento para previewImagen
    const fakeEvent = {
        target: {
            files: [file]
        }
    };
    previewImagen(fakeEvent);

    // Analizar autom√°ticamente despu√©s de un momento
    setTimeout(() => {
        analizarImagen();
    }, 500);
}

/* ============================= */
/* FUNCIONES DEL CHATBOT */
/* ============================= */

function enviarMensaje() {
    const input = document.getElementById('userMessage');
    const mensaje = input.value.trim();
    
    if (!mensaje) return;
    
    // Agregar mensaje del usuario al chat
    agregarMensajeUsuario(mensaje);
    
    // Limpiar input
    input.value = '';
    
    // Responder (simulando respuesta del bot)
    setTimeout(() => {
        responderMensaje(mensaje);
    }, 500);
}

function agregarMensajeUsuario(texto) {
    const chatMessages = document.getElementById('chat-messages');
    const mensajeDiv = document.createElement('div');
    mensajeDiv.className = 'message user';
    mensajeDiv.textContent = texto;
    chatMessages.appendChild(mensajeDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function agregarMensajeBot(texto) {
    const chatMessages = document.getElementById('chat-messages');
    const mensajeDiv = document.createElement('div');
    mensajeDiv.className = 'message bot';
    mensajeDiv.textContent = texto;
    chatMessages.appendChild(mensajeDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function responderMensaje(mensaje) {
    const mensajeLower = mensaje.toLowerCase();
    
    // Respuestas basadas en palabras clave
    let respuesta = '';
    
    if (mensajeLower.includes('prote√≠na') || mensajeLower.includes('proteina')) {
        respuesta = 'La cantidad de prote√≠na recomendada depende de varios factores:\n\n' +
                   '‚Ä¢ Sedentarios: 0.8g por kg de peso\n' +
                   '‚Ä¢ Activos: 1.2-1.7g por kg de peso\n' +
                   '‚Ä¢ Atletas: 1.8-2.2g por kg de peso\n\n' +
                   'Por ejemplo, si pesas 70kg y eres activo, necesitas entre 84-119g de prote√≠na al d√≠a.';
    } else if (mensajeLower.includes('adelgazar') || mensajeLower.includes('bajar peso') || mensajeLower.includes('perder peso')) {
        respuesta = 'Para adelgazar de forma saludable:\n\n' +
                   '‚Ä¢ Crea un d√©ficit cal√≥rico moderado (300-500 kcal/d√≠a)\n' +
                   '‚Ä¢ Prioriza prote√≠nas y vegetales\n' +
                   '‚Ä¢ Bebe mucha agua (2-2.5L/d√≠a)\n' +
                   '‚Ä¢ Realiza ejercicio regular\n' +
                   '‚Ä¢ Duerme 7-8 horas\n' +
                   '‚Ä¢ Ten paciencia, el proceso toma tiempo';
    } else if (mensajeLower.includes('snack') || mensajeLower.includes('tentempi√©')) {
        respuesta = 'Mejores snacks saludables:\n\n' +
                   '‚Ä¢ Frutas frescas (manzana, pl√°tano, frutos rojos)\n' +
                   '‚Ä¢ Frutos secos (almendras, nueces) - m√°ximo 30g\n' +
                   '‚Ä¢ Yogurt griego sin az√∫car\n' +
                   '‚Ä¢ Hummus con vegetales\n' +
                   '‚Ä¢ Batido de prote√≠na\n' +
                   '‚Ä¢ Huevo duro';
    } else if (mensajeLower.includes('agua') || mensajeLower.includes('hidrataci√≥n') || mensajeLower.includes('hidratacion')) {
        respuesta = 'Recomendaciones de hidrataci√≥n:\n\n' +
                   '‚Ä¢ Bebe 2-2.5 litros de agua al d√≠a\n' +
                   '‚Ä¢ M√°s si haces ejercicio o hace calor\n' +
                   '‚Ä¢ El agua es la mejor opci√≥n\n' +
                   '‚Ä¢ Evita bebidas azucaradas\n' +
                   '‚Ä¢ Los alimentos con mucha agua (frutas, verduras) tambi√©n ayudan';
    } else if (mensajeLower.includes('entreno') || mensajeLower.includes('ejercicio') || mensajeLower.includes('pre-entreno')) {
        respuesta = 'Nutrici√≥n pre-entreno:\n\n' +
                   '‚Ä¢ Come 1-2 horas antes del ejercicio\n' +
                   '‚Ä¢ Carbohidratos complejos (avena, pl√°tano)\n' +
                   '‚Ä¢ Prote√≠na ligera si es necesario\n' +
                   '‚Ä¢ Hidr√°tate bien\n' +
                   '‚Ä¢ Evita comidas pesadas o grasosas\n\n' +
                   'Ejemplo: avena con pl√°tano 1 hora antes';
    } else if (mensajeLower.includes('desayuno')) {
        respuesta = 'Ideas de desayunos saludables:\n\n' +
                   '‚Ä¢ Avena con frutas y nueces\n' +
                   '‚Ä¢ Yogurt griego con granola y frutas\n' +
                   '‚Ä¢ Huevos revueltos con espinacas y tostada integral\n' +
                   '‚Ä¢ Smoothie con prote√≠na\n' +
                   '‚Ä¢ Tostadas integrales con aguacate y huevo\n\n' +
                   'Incluye prote√≠na, carbohidratos complejos y algo de grasa saludable.';
    } else if (mensajeLower.includes('calor√≠as') || mensajeLower.includes('calorias') || mensajeLower.includes('calor√≠a')) {
        respuesta = 'Las calor√≠as son la energ√≠a que nuestro cuerpo necesita:\n\n' +
                   'üìä **C√°lculo b√°sico**:\n' +
                   '‚Ä¢ Mujeres: 1800-2200 kcal/d√≠a (sedentarias)\n' +
                   '‚Ä¢ Hombres: 2200-2600 kcal/d√≠a (sedentarios)\n' +
                   '‚Ä¢ Aumenta con actividad f√≠sica\n\n' +
                   'üéØ **Distribuci√≥n recomendada**:\n' +
                   '‚Ä¢ 45-65% Carbohidratos\n' +
                   '‚Ä¢ 10-35% Prote√≠nas\n' +
                   '‚Ä¢ 20-35% Grasas\n\n' +
                   'üí° Calcula tu IMC primero para obtener tu necesidad cal√≥rica personalizada.';
    } else if (mensajeLower.includes('dieta') || mensajeLower.includes('plan alimenticio')) {
        respuesta = 'Un buen plan alimenticio incluye:\n\n' +
                   '‚òÄÔ∏è **Desayuno** (25% del d√≠a):\n' +
                   '‚Ä¢ Prote√≠na + Carbohidratos complejos\n' +
                   '‚Ä¢ Ejemplo: Avena con frutas y yogur\n\n' +
                   'üçΩÔ∏è **Almuerzo** (35% del d√≠a):\n' +
                   '‚Ä¢ Prote√≠na + Vegetales + Carbohidratos\n' +
                   '‚Ä¢ Ejemplo: Pollo + Ensalada + Arroz integral\n\n' +
                   'üåô **Cena** (25% del d√≠a):\n' +
                   '‚Ä¢ Prote√≠na ligera + Vegetales\n' +
                   '‚Ä¢ Ejemplo: Pescado + Verduras al vapor\n\n' +
                   'üçè **Snacks** (15% restante):\n' +
                   '‚Ä¢ Frutas, frutos secos, yogur\n\n' +
                   'üìä Calcula tu IMC para recibir un plan personalizado basado en tus necesidades.';
    } else {
        respuesta = 'Gracias por tu pregunta. Puedo ayudarte con:\n\n' +
                   'üí° **Consejos de nutrici√≥n** - Preg√∫ntame sobre alimentaci√≥n saludable\n' +
                   'üì∑ **An√°lisis de im√°genes** - Usa el bot√≥n üì∑ para analizar tu comida\n' +
                   'üìä **C√°lculo de IMC** - Ve a "Calculadora IMC" para un plan personalizado\n' +
                   '‚ùì **Preguntas frecuentes** - Usa los botones de abajo\n\n' +
                   '¬øHay algo espec√≠fico sobre nutrici√≥n que te gustar√≠a saber?';
    }
    
    agregarMensajeBot(respuesta);
}

function hacerPregunta(pregunta) {
    const input = document.getElementById('userMessage');
    input.value = pregunta;
    enviarMensaje();
}

/* ============================= */
/* DRAG & DROP */
/* ============================= */

function handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('uploadArea').classList.add('drag-over');
}

function handleDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('uploadArea').classList.remove('drag-over');
}

function handleDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('uploadArea').classList.remove('drag-over');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('image/')) {
            imagenActual = file;
            
            // Mostrar vista previa
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('uploadArea').classList.add('hidden');
                document.getElementById('imagePreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            alert('Por favor, arrastra solo im√°genes');
        }
    }
}

</script>

<!-- Cargar configuraci√≥n del contrato -->
<script src="js/contract-config.js"></script>

<!-- Funciones de Blockchain -->
<script>
// =============================
// BLOCKCHAIN / WEB3 FUNCTIONS
// =============================

let walletAddress = null;
let provider = null;
let signer = null;
let contract = null;

// Detectar Wallet (MetaMask, Core Wallet, etc.)
function detectarWallet() {
    if (typeof window.ethereum !== 'undefined') {
        return true;
    }
    return false;
}

// Cambiar a red Sepolia autom√°ticamente
async function cambiarARedSepolia() {
    try {
        // Par√°metros de Sepolia
        const sepoliaParams = {
            chainId: '0xaa36a7', // 11155111 en hexadecimal
            chainName: 'Sepolia',
            nativeCurrency: {
                name: 'Ether',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://rpc.sepolia.org'],
            blockExplorerUrls: ['https://sepolia.etherscan.io']
        };

        // Intentar agregar/cambiar a Sepolia
        await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [sepoliaParams]
        });

        return true;
    } catch (error) {
        console.error('Error cambiando a Sepolia:', error);
        
        // Si el error es que el usuario rechaz√≥, retornar false
        if (error.code === 4001 || error.code === -32002) {
            return false;
        }
        
        // Si la cadena ya existe, intentar cambiar
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0xaa36a7' }]
            });
            return true;
        } catch (switchError) {
            console.error('Error cambiando a Sepolia:', switchError);
            return false;
        }
    }
}

// Conectar Wallet
async function conectarWallet() {
    // Verificar que ethers est√© disponible
    if (typeof ethers === 'undefined') {
        alert('Error: Ethers.js no est√° cargado. Por favor, recarga la p√°gina.');
        console.error('Ethers.js no est√° disponible');
        return false;
    }

    if (!detectarWallet()) {
        alert('No se detect√≥ una wallet. Por favor, instala MetaMask o Core Wallet');
        return false;
    }

    try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // Solicitar acceso a la cuenta
        await provider.send("eth_requestAccounts", []);
        
        signer = provider.getSigner();
        walletAddress = await signer.getAddress();

        // Verificar que est√© en la red correcta (Sepolia)
        const network = await provider.getNetwork();
        const expectedChainId = CONTRACT_CONFIG.NETWORK.chainId;
        
        if (network.chainId !== expectedChainId) {
            // Intentar cambiar a Sepolia autom√°ticamente
            const cambioExitoso = await cambiarARedSepolia();
            if (!cambioExitoso) {
                alert(`Por favor cambia manualmente a la red ${CONTRACT_CONFIG.NETWORK.name.toUpperCase()} (Chain ID: ${expectedChainId})`);
                return false;
            }
            // Despu√©s de cambiar, recargar provider
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            walletAddress = await signer.getAddress();
        }

        // Actualizar UI
        document.getElementById('walletBtn').classList.add('hidden');
        document.getElementById('walletInfo').classList.remove('hidden');
        document.getElementById('walletAddress').textContent = 
            `${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`;

        // Cargar ABI y inicializar contrato
        const abi = await getABI();
        contract = new ethers.Contract(CONTRACT_CONFIG.ADDRESS, abi, signer);

        console.log('Wallet conectada:', walletAddress);
        console.log('Contrato inicializado:', CONTRACT_CONFIG.ADDRESS);

        return true;
    } catch (error) {
        console.error('Error conectando wallet:', error);
        alert('Error al conectar wallet: ' + error.message);
        return false;
    }
}

// Desconectar Wallet
function desconectarWallet() {
    walletAddress = null;
    provider = null;
    signer = null;
    contract = null;
    
    document.getElementById('walletBtn').classList.remove('hidden');
    document.getElementById('walletInfo').classList.add('hidden');
}

// Toggle Wallet (conectar/desconectar)
async function toggleWallet() {
    if (walletAddress) {
        desconectarWallet();
    } else {
        await conectarWallet();
    }
}

// Guardar an√°lisis en Blockchain
async function guardarEnBlockchain() {
    if (!walletAddress) {
        const conectado = await conectarWallet();
        if (!conectado) return;
    }

    if (!window.resultadoActual || !window.resultadoActual.ipfs) {
        alert('No hay an√°lisis disponible para guardar. Primero analiza una imagen.');
        return;
    }

    try {
        const resultado = window.resultadoActual;
        const analisis = resultado.analisis;
        const recomendacion = resultado.recomendacion;
        const ipfs = resultado.ipfs;

        // Mostrar estado de carga
        const txStatus = document.getElementById('txStatus');
        const btnGuardar = document.getElementById('btnGuardarBlockchain');
        txStatus.classList.remove('hidden');
        txStatus.innerHTML = '<p>‚è≥ Preparando transacci√≥n...</p>';
        btnGuardar.disabled = true;

        // Preparar datos
        const cidIPFS = ipfs.cid;
        const porcionCorrecta = analisis.porcion_correcta;
        const confianza = Math.round(analisis.confianza * 100); // Convertir a 0-100
        const calorias = recomendacion.calorias_estimadas;

        console.log('Guardando an√°lisis:', { cidIPFS, porcionCorrecta, confianza, calorias });

        // Llamar al Smart Contract
        const tx = await contract.guardarAnalisis(
            cidIPFS,
            porcionCorrecta,
            confianza,
            calorias
        );

        txStatus.innerHTML = '<p>‚è≥ Transacci√≥n enviada. Esperando confirmaci√≥n...</p>';
        
        // Esperar confirmaci√≥n
        const receipt = await tx.wait();

        // Obtener URL del explorador
        const explorerUrl = getExplorerUrl(CONTRACT_CONFIG.NETWORK.name, receipt.transactionHash);

        // Actualizar UI con √©xito
        txStatus.innerHTML = `
            <p>‚úÖ Guardado exitosamente en blockchain</p>
            <a href="${explorerUrl}" target="_blank" id="txLink">Ver transacci√≥n en Etherscan ‚Üí</a>
        `;
        btnGuardar.disabled = false;

        console.log('Transacci√≥n confirmada:', receipt.transactionHash);
        
        // Mostrar mensaje de √©xito
        alert('‚úÖ An√°lisis guardado exitosamente en blockchain!');

    } catch (error) {
        console.error('Error guardando en blockchain:', error);
        const txStatus = document.getElementById('txStatus');
        const btnGuardar = document.getElementById('btnGuardarBlockchain');
        txStatus.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
        btnGuardar.disabled = false;
        
        // Mensaje de error m√°s amigable
        if (error.message.includes('user rejected')) {
            alert('Transacci√≥n cancelada por el usuario');
        } else if (error.message.includes('insufficient funds')) {
            alert('Fondos insuficientes. Necesitas ETH de prueba en Sepolia');
        } else {
            alert('Error al guardar en blockchain: ' + error.message);
        }
    }
}

// Obtener historial desde Blockchain
async function cargarHistorial() {
    if (!walletAddress) {
        document.getElementById('historialVacio').classList.remove('hidden');
        document.getElementById('historialList').innerHTML = '';
        document.getElementById('historialLoading').classList.add('hidden');
        return;
    }

    try {
        document.getElementById('historialLoading').classList.remove('hidden');
        document.getElementById('historialVacio').classList.add('hidden');
        document.getElementById('historialList').innerHTML = '';
        
        // Obtener IDs de an√°lisis del usuario
        const analisisIds = await contract.obtenerAnalisisUsuario(walletAddress);
        
        console.log('An√°lisis encontrados:', analisisIds.length);

        if (analisisIds.length === 0) {
            document.getElementById('historialVacio').classList.remove('hidden');
            document.getElementById('historialLoading').classList.add('hidden');
            return;
        }

        // Obtener cada an√°lisis
        const historialList = document.getElementById('historialList');
        const promesas = analisisIds.map(id => contract.obtenerAnalisis(id));
        const analisisArray = await Promise.all(promesas);

        // Renderizar historial (orden inverso: m√°s reciente primero)
        analisisArray.reverse().forEach((analisis, index) => {
            const div = document.createElement('div');
            div.className = 'historial-item';
            
            const fecha = new Date(analisis.timestamp.toNumber() * 1000);
            const fechaStr = fecha.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            div.innerHTML = `
                <div class="historial-header">
                    <span>An√°lisis #${analisisArray.length - index}</span>
                    <small>${fechaStr}</small>
                </div>
                <div class="historial-content">
                    <p><strong>CID IPFS:</strong> <code>${analisis.cidIPFS}</code></p>
                    <p><strong>Porci√≥n:</strong> ${analisis.porcionCorrecta ? '‚úÖ Correcta' : '‚ö†Ô∏è Exceso'}</p>
                    <p><strong>Confianza:</strong> ${analisis.confianza.toNumber()}%</p>
                    <p><strong>Calor√≠as:</strong> ${analisis.calorias.toNumber()} kcal</p>
                    <a href="https://gateway.pinata.cloud/ipfs/${analisis.cidIPFS}" target="_blank" style="color: #0284c7; text-decoration: none;">
                        üîó Ver imagen en IPFS ‚Üí
                    </a>
                </div>
            `;
            historialList.appendChild(div);
        });

        document.getElementById('historialLoading').classList.add('hidden');
    } catch (error) {
        console.error('Error cargando historial:', error);
        document.getElementById('historialLoading').classList.add('hidden');
        document.getElementById('historialVacio').classList.remove('hidden');
        alert('Error al cargar historial: ' + error.message);
    }
}

// Detectar cambios de cuenta en la wallet
if (typeof window.ethereum !== 'undefined') {
    window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
            desconectarWallet();
        } else {
            conectarWallet();
        }
    });
    
    window.ethereum.on('chainChanged', () => {
        window.location.reload();
    });
}
</script>

</body>
</html>
